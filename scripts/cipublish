#!/bin/bash

set -e

if [[ -n "${NASA_HSI_DEBUG}" ]]; then
    set -x
fi

function usage() {
    echo -n \
        "Usage: $(basename "$0")
Publish container images to Elastic Container Registry (ECR).
"
}

if [[ -n "${GIT_COMMIT}" ]]; then
    GIT_COMMIT="${GIT_COMMIT:0:7}"
else
    GIT_COMMIT="$(git rev-parse --short HEAD)"
fi

function amazon_ecr_login() {
    # Retrieves a temporary authorization token that can be used to access
    # Amazon ECR, along with the registry URL.
    read -r AUTHORIZATION_TOKEN ECR_REGISTRY \
        <<<"$(aws ecr get-authorization-token \
            --output "text" \
            --query "authorizationData[0].[authorizationToken, proxyEndpoint]")"

    # The authorization token is base64 encoded, and we need to strip the
    # protocol from the registry URL.
    AUTHORIZATION_TOKEN="$(echo "${AUTHORIZATION_TOKEN}" | base64 -d)"
    ECR_REGISTRY="${ECR_REGISTRY##*://}"

    # Authenticate to the ECR registry. The authorization token is presented in
    # the format user:password.
    echo "${AUTHORIZATION_TOKEN##*:}" |
        docker login \
            --username "${AUTHORIZATION_TOKEN%%:*}" \
            --password-stdin "${ECR_REGISTRY}"
}

if [[ "${BASH_SOURCE[0]}" == "$0" ]]; then
    if [[ "${1:-}" == "--help" ]]; then
        usage
    else
        # Login to Amazon ECR with the local Docker client.
        amazon_ecr_login

        # Tag and publish the Aviris L1 activator.
        docker tag "activator-aviris-l1:${GIT_COMMIT}" \
            "${ECR_REGISTRY}/activator-aviris-l1:${GIT_COMMIT}"

        docker tag "activator-aviris-l1:${GIT_COMMIT}" \
            "${ECR_REGISTRY}/activator-aviris-l1:latest"

        docker push "${ECR_REGISTRY}/activator-aviris-l1:${GIT_COMMIT}"
        docker push "${ECR_REGISTRY}/activator-aviris-l1:latest"

        # Tag and publish the Aviris L2 activator.
        docker tag "activator-aviris-l2:${GIT_COMMIT}" \
            "${ECR_REGISTRY}/activator-aviris-l2:${GIT_COMMIT}"

        docker tag "activator-aviris-l2:${GIT_COMMIT}" \
            "${ECR_REGISTRY}/activator-aviris-l2:latest"

        docker push "${ECR_REGISTRY}/activator-aviris-l2:${GIT_COMMIT}"
        docker push "${ECR_REGISTRY}/activator-aviris-l2:latest"

        # Tag and publish the PRISMA activator.
        docker tag "activator-prisma:${GIT_COMMIT}" \
            "${ECR_REGISTRY}/activator-prisma:${GIT_COMMIT}"

        docker tag "activator-prisma:${GIT_COMMIT}" \
            "${ECR_REGISTRY}/activator-prisma:latest"   

        docker push "${ECR_REGISTRY}/activator-prisma:${GIT_COMMIT}"
        docker push "${ECR_REGISTRY}/activator-prisma:latest"

        # Tag and publish the Sentinel activator.
        docker tag "activator-sentinel-s2:${GIT_COMMIT}" \
            "${ECR_REGISTRY}/activator-sentinel-s2:${GIT_COMMIT}"

        docker tag "activator-sentinel-s2:${GIT_COMMIT}" \
            "${ECR_REGISTRY}/activator-sentinel-s2:latest"   

        docker push "${ECR_REGISTRY}/activator-sentinel-s2:${GIT_COMMIT}"
        docker push "${ECR_REGISTRY}/activator-sentinel-s2:latest"

        # Tag and publish the COG Clip module.
        docker tag "cog-clip:${GIT_COMMIT}" \
            "${ECR_REGISTRY}/cog-clip:${GIT_COMMIT}"

        docker tag "cog-clip:${GIT_COMMIT}" \
            "${ECR_REGISTRY}/cog-clip:latest"

        docker push "${ECR_REGISTRY}/cog-clip:${GIT_COMMIT}"
        docker push "${ECR_REGISTRY}/cog-clip:latest"
    fi
fi
